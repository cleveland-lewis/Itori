#!/bin/bash
#
# pre-commit hook for Itori
# Ensures tests pass before committing
#
# Install: cp Scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
#

set -e

echo "üß™ Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check for Swift files in commit
SWIFT_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep "\.swift$" || true)

if [ -z "$SWIFT_FILES" ]; then
    echo "‚úÖ No Swift files to check"
    exit 0
fi

echo "üìù Found Swift files to check:"
echo "$SWIFT_FILES"
echo ""

# Check for new files without tests
echo "üîç Checking for untested files..."
UNTESTED_FILES=""

for FILE in $SWIFT_FILES; do
    # Skip test files themselves
    if [[ "$FILE" == *"Tests"* ]]; then
        continue
    fi
    
    # Skip certain directories that don't need tests
    if [[ "$FILE" == *"DesignSystem/Components"* ]] || \
       [[ "$FILE" == *"Views/"* ]] || \
       [[ "$FILE" == *"Platform"* ]]; then
        continue
    fi
    
    # Extract filename
    BASENAME=$(basename "$FILE" .swift)
    TEST_FILE="Tests/Unit/ItoriTests/${BASENAME}Tests.swift"
    
    if [ ! -f "$TEST_FILE" ]; then
        UNTESTED_FILES="$UNTESTED_FILES\n  - $FILE"
    fi
done

if [ -n "$UNTESTED_FILES" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: The following files don't have tests:${NC}"
    echo -e "$UNTESTED_FILES"
    echo ""
    echo "üí° Generate test stubs with:"
    for FILE in $SWIFT_FILES; do
        if [[ "$FILE" != *"Tests"* ]]; then
            BASENAME=$(basename "$FILE" .swift)
            TEST_FILE="Tests/Unit/ItoriTests/${BASENAME}Tests.swift"
            if [ ! -f "$TEST_FILE" ]; then
                echo "   ./Scripts/generate_test_stub.sh $FILE"
            fi
        fi
    done
    echo ""
    
    # Ask user if they want to continue
    read -p "Continue without tests? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${RED}‚ùå Commit aborted${NC}"
        exit 1
    fi
fi

# Run unit tests
echo "üß™ Running unit tests..."

if xcodebuild test \
    -scheme Itori \
    -destination 'platform=macOS' \
    -only-testing:ItoriTests \
    -quiet 2>&1 | tee /tmp/test_output.log | grep -E "Test Suite|FAILED|PASSED"; then
    
    # Check if tests actually passed
    if grep -q "** TEST FAILED **" /tmp/test_output.log; then
        echo -e "${RED}‚ùå Tests failed${NC}"
        echo ""
        echo "Failed tests:"
        grep "failed" /tmp/test_output.log | grep "Test Case" || true
        echo ""
        echo "Fix tests before committing."
        exit 1
    fi
    
    echo -e "${GREEN}‚úÖ All tests passed${NC}"
else
    echo -e "${RED}‚ùå Tests failed${NC}"
    exit 1
fi

# Check for common issues
echo "üîç Checking for common issues..."

# Check for force unwraps in new code
FORCE_UNWRAPS=$(git diff --cached --name-only --diff-filter=ACMR | \
    grep "\.swift$" | \
    xargs git diff --cached | \
    grep "^+" | \
    grep -c "!" || true)

if [ "$FORCE_UNWRAPS" -gt 5 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: $FORCE_UNWRAPS force unwraps (!) found in new code${NC}"
    echo "Consider using optional binding instead"
fi

# Check for print statements (should use DebugLogger)
PRINT_STATEMENTS=$(git diff --cached --name-only --diff-filter=ACMR | \
    grep "\.swift$" | \
    xargs git diff --cached | \
    grep "^+" | \
    grep -c "print(" || true)

if [ "$PRINT_STATEMENTS" -gt 0 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: $PRINT_STATEMENTS print() statements found${NC}"
    echo "Use DebugLogger.log() instead for consistent logging"
fi

echo ""
echo -e "${GREEN}‚úÖ Pre-commit checks passed${NC}"
echo "üöÄ Proceeding with commit..."

exit 0
