name: UI & UX Tests

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  macos-ui:
    name: macOS UI Tests
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: ./.github/actions/checkout
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Select Xcode
        uses: ./.github/actions/setup-xcode
        with:
          xcode-version: latest-stable
      - name: Install xcpretty
        run: gem install --no-document xcpretty
      - name: Run macOS UI tests
        run: |
          set -o pipefail
          LOG="$GITHUB_WORKSPACE/xcodebuild-macos-ui.log"
          JUNIT="$GITHUB_WORKSPACE/macos-ui-tests.xml"
          if [ -f "Roots.xcworkspace" ]; then
            xcodebuild -workspace "Roots.xcworkspace" -scheme "Roots" -destination "platform=macOS" -only-testing:RootsUITests test | tee "$LOG" | xcpretty -r junit --output "$JUNIT"
          elif [ -f "Roots.xcodeproj" ]; then
            xcodebuild -project "Roots.xcodeproj" -scheme "Roots" -destination "platform=macOS" -only-testing:RootsUITests test | tee "$LOG" | xcpretty -r junit --output "$JUNIT"
          else
            echo "no project/workspace" && exit 1
          fi
      - name: Upload macOS UI artifacts
        uses: ./.github/actions/upload-artifact
        with:
          name: macos-ui-logs
          path: "${{ github.workspace }}/xcodebuild-macos-ui.log\n${{ github.workspace }}/macos-ui-tests.xml"
          token: ${{ secrets.GITHUB_TOKEN }}

  ios-ui:
    name: iOS UI Tests (Simulator)
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: ./.github/actions/checkout
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Select Xcode
        uses: ./.github/actions/setup-xcode
        with:
          xcode-version: latest-stable
      - name: Install tools
        run: gem install --no-document xcpretty
      - name: Boot Simulator
        run: |
          xcrun simctl bootstatus "iPhone 14" -b || xcrun simctl boot "iPhone 14"
      - name: Run iOS UI tests
        run: |
          set -o pipefail
          LOG="$GITHUB_WORKSPACE/xcodebuild-ios-ui.log"
          JUNIT="$GITHUB_WORKSPACE/ios-ui-tests.xml"
          if [ -f "Roots.xcworkspace" ]; then
            xcodebuild -workspace "Roots.xcworkspace" -scheme "Roots-iOS" -destination "platform=iOS Simulator,name=iPhone 14" -only-testing:RootsUITests test | tee "$LOG" | xcpretty -r junit --output "$JUNIT"
          elif [ -f "Roots.xcodeproj" ]; then
            xcodebuild -project "Roots.xcodeproj" -scheme "Roots-iOS" -destination "platform=iOS Simulator,name=iPhone 14" -only-testing:RootsUITests test | tee "$LOG" | xcpretty -r junit --output "$JUNIT"
          else
            echo "no project/workspace" && exit 1
          fi
      - name: Upload iOS UI artifacts
        uses: ./.github/actions/upload-artifact
        with:
          name: ios-ui-logs
          path: "${{ github.workspace }}/xcodebuild-ios-ui.log\n${{ github.workspace }}/ios-ui-tests.xml"
          token: ${{ secrets.GITHUB_TOKEN }}
